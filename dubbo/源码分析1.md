### SPI
Dubbo采用微内核+插件体系。设计优雅，可扩展性强。  
微内核+插件体系的实现是基于SPI机制。（service provider interface）  
框架定义服务标准接口，使用者可以自己扩展服务实现。  

1, Dubbo定义了`@SPI`注解  
对于打了@spi注解的接口，dubbo会从以下目录依次查找实现。
META-INF/dubbo/internal/ //dubbo 内部实现的各种扩展都放在了这个目录  
了
META-INF/dubbo/  
META-INF/services/  

2, ExtensionLoader是SPI加载器。
`com.alibaba.dubbo.common.extension.ExtensionLoader#loadExtensionClasses`

### 服务暴露
关注`com.alibaba.dubbo.config.spring.ServiceBean`  
管理服务的生命周期。  

1. setApplicationContext 设置容器 applicationContext
2. afterPropertiesSet 回调InitializingBean 的 afterPropertiesSet  
3. onApplicationEvent spring的最后一步 finishRefresh 会触发 ContextRefreshedEvent 事件，而 ServiceBean
实现了 ApplicationListener 接口监听了此事件， 而在之前一步实例化的
ServiceBean 注 册 了 这 个 事 件 ， 所 以 ServiceBean 的
onApplicationEvent(ApplicationEvent event)方法被触发， 在这个方法中触
发了 export 方法来暴露服务。  
4. destroy 服务下线  

#### export
看一下export具体是怎么实现的  
`com.alibaba.dubbo.config.ServiceConfig#export`  

1. 校验和数据准备
2. `com.alibaba.dubbo.config.AbstractInterfaceConfig#loadRegistries`  
获取注册地址`dubbo.registry.address`。从 dubbo.properties 中读取配
置，构建 RegistryConfig 对象并赋值
构建注册中心 URL 统一数据模式集合 List<registryUrl>
3. 遍历所有协议分别根据不同的协议把服务
export 到不同的注册中心上去  
4. 向服务中心注册
5. 创建回调监听

### 服务引用
关注`com.alibaba.dubbo.config.spring.ReferenceBean`  
ReferenceBean实现了FactoryBean接口，spring的bean工厂在获取的bean的时候会判断下是不是FactoryBean的实例，如果是调factoryBean.getObject()返回，否则返回bean。  
我们使用时并不是想要ReferenceBean这个实例，而是希望通过这个实例获取对应的代理，通过代理调用远程服务。  
所以在factoryBean.getObject()中封装了复杂实现，使我们可以拿到代理对象。  

1. ReferenceBean实现InitializingBean接口，spring回调afterPropertiesSet()
2. 



