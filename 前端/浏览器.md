## 浏览器是如何工作的

你有没有曾经好奇过，浏览器究竟是如何工作的？当你输入www.baidu.com之后究竟发生了什么？

### 浏览器
目前主要有5中浏览器在使用。Chrome，Ie，FireFox，Safari，Opera。  
根据统计[https://www.w3schools.com/browsers/default.asp](https://www.w3schools.com/browsers/default.asp)可以看到目前Chrome的占有率真是遥遥领先。  
### 浏览器的主要作用
浏览器的主要作用就是展示web资源。通过向服务器请求资源，然后展示在浏览器的界面上。  
资源的格式通常是Html，但也可以是pdf、img等等。  
这些资源的地址用URI（统一资源定位）来表示。  

浏览器展示Html页面是按照Html和Css规则来解析的。这些规则是由W3C来制定和管理的。W3C是web界的国际标准化组织。  

当前Html的最新版本是Html5，Css的最新版本是Css3。  

各个浏览器都有一些通用的功能，比如：  

- 地址输入栏
- 前进/后退按钮
- 书签功能
- 刷新/停止按钮
- 主页按钮

这些功能都不是W3C要求的，只是在多年实践中，各个浏览器厂商发现的最佳实践。

### 浏览器组成
浏览器主要由一下几部分组成：

- 用户界面。比如地址栏、工具按钮等等
- 浏览器引擎。用来查询和操作渲染引擎的接口。
- 渲染引擎。负责根据请求的内容展示请求。比如资源是Html页面，那么渲染引擎会根据Html和Css规则解析这个页面，然后展示出来。
- 网络模块。负责网络连接，根据平台（linux、windows、mac）不同有不同的实现。
- UI模块。用来画最基础的展示组件。对外暴露的接口时平台无关的，但是内部的实现是针对具体运行的平台的。  
- JavaScript 解析器。服务解析和执行JavaScript代码。
- 数据存储。这是持久层，负责存储浏览器用到的所有数据到硬盘上，比如cookie。

![组成](/browser/layers.png)

值得注意的是,Chrome,会持有多个渲染引擎。每个Tab页一个。每个tab页都是一个单独的进程。  

### 渲染引擎
如前所属，渲染引擎的主要作用就是渲染。  
默认的，渲染引擎可以展示Html、Xml文档，以及图片资源。但是浏览器扩展插件，可以展示更多资源。先来看渲染Html和图片。  

Firefox使用的是自家产的Gecko渲染引擎。  
Chrome和Safari使用的是开源的Webkit。Webkit最初是Linux平台的渲染引擎，后来经过Apple的改造，支持了Mac和Windows平台。[https://webkit.org/](https://webkit.org/)  

#### 数据流
渲染引擎从网络层得到响应的资源，通常是8K大小的数据块。然后按下面的流程走。
![](/browser/flow.png)

1. 首先解析html文档，将tag标签解析成Dom树
2. 解析style资源，包括外部的css文件和css元素标签。和Dom树组合生成渲染树。渲染树是由一个个有颜色和大小属性的矩形组成。这些矩形会按照正确的顺序一个个展示在浏览器窗口上。
3. 布局阶段。给与渲染树上的每一个节点（小矩形）准确的位置坐标。
4. 画。最后就是使用UI层的能力，将渲染树画出。

要注意的是这是一个渐进的过程。为了更好的用户体验，渲染引擎会尽快的展现页面，并不会一直要等到所有的Html元素全部被解析才开始渲染和绘画。当一部分内容还在网络传输过程中，另一部分内容已经渲染完毕展示出来了。  

webkit的渲染过程：

![webkit的渲染过程](/browser/webkitflow.png)


#### 解析
渲染引擎工作的核心是解析过程。  
解析一个文档意味着将其转化为一个有意义的结构。通常是一个节点树，代表着一个Html文档的结构。将这种节点树称为解析树或者语法树。

例如将“2+3-1”进行解析，得到下面的语法树。
![](/browser/image009.png)

解析是建立在html文档遵循的语法规则上的。这个规则有确定的词汇和语法。  

解析可以被分解成两个确定的过程：词汇解析和语法解析。  
词汇解析就是将文档打散成一个个合法的词汇。  
语法解析就是对词汇使用语法规则。  

这两个过程分别对应渲染引擎的两个组件--分词器和解析器。  

分词器会根据空格和换行切分词汇。  
![](/browser/image011.png)  
整个解析过程是迭代进行的。解析器会从分词器得到一个新的关键字，然后去匹配语法规则。如果匹配到，这个关键字对应的节点会加载到语法树上，然后去解析下一个关键字。  
如果没有匹配到规则，解析器会将这个关键字暂存，然后请求下一个关键字。接着和暂存的关键字一起去匹配规则，如果匹配到，同样生成节点加载到语法树上。如果直到文档的关键字都加载完了还是匹配不到规则，那么就会报错，意味着这个html文档是不合法的，存在语法错误。  


#### 转换
解析得到的语法树通常不会是最终产品。这个过程可以理解为编译器做的工作。将语法树转换成机器码。  
![](/browser/image013.png)
 


